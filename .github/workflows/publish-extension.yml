name: å‘å¸ƒæ‰©å±•åˆ°å¤šä¸ªåº”ç”¨å•†åº—

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: éªŒè¯ manifest.json
        run: |
          # éªŒè¯ manifest.json æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
          echo "âœ… manifest.json æ ¼å¼æœ‰æ•ˆ"

      - name: ä»è¾“å…¥è®¾ç½®ç‰ˆæœ¬
        id: version
        run: |
          # ä½¿ç”¨æ‰‹åŠ¨æä¾›çš„ç‰ˆæœ¬
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æ‰‹åŠ¨è®¾ç½®ç‰ˆæœ¬: $VERSION"

      - name: æ›´æ–° manifest ç‰ˆæœ¬
        run: |
          # æ›´æ–° manifest.json ä¸­çš„ç‰ˆæœ¬ä»¥åŒ¹é…æ ‡ç­¾
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

      - name: æ›´æ–° package.json ç‰ˆæœ¬
        run: |
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬ä»¥åŒ¹é…æ ‡ç­¾
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('å·²æ›´æ–° package.json ç‰ˆæœ¬ä¸º:', pkg.version);
          "

      - name: æäº¤å¹¶æ¨é€ç‰ˆæœ¬æ›´æ–°
        run: |
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯ä»¥è¿›è¡Œæäº¤
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
          git add manifest.json package.json

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰ç‰ˆæœ¬æ›´æ”¹éœ€è¦æäº¤"
          else
            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git commit -m "chore: æ›´æ–°ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }} [skip ci]"
            
            # ä¸ºæ­¤ç‰ˆæœ¬åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
            git tag "v${{ steps.version.outputs.version }}"
            
            # æ¨é€åˆ°ä¸»åˆ†æ”¯å¹¶åŒ…å«æ ‡ç­¾
            git push origin HEAD:main
            git push origin "v${{ steps.version.outputs.version }}"
            
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼ŒåŒ…å«æ ‡ç­¾"
          fi

      - name: åˆ›å»ºæ‰©å±•åŒ…
        run: |
          # åˆ›å»º Chrome æ‰©å±• zip åŒ…
          zip -r chrome-extension.zip . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x ".github/*" \
            -x "*.md" \
            -x "LICENSE" \
            -x "*.zip" \
            -x "*.crx"

          # åˆ›å»º Microsoft Edge æ‰©å±• zip åŒ…ï¼ˆä¸ Chrome çš„ MV3 ç›¸åŒï¼‰
          cp chrome-extension.zip edge-extension.zip

          echo "ğŸ“¦ å·²åˆ›å»ºæ‰©å±•åŒ…"
          ls -la *.zip

      - name: ä¸º GitHub å‘å¸ƒåˆ›å»º CRX æ–‡ä»¶
        run: |
          # å®‰è£… chrome-extension-packer
          npm install -g crx3

          # ä¸º CRX ç­¾ååˆ›å»ºç§é’¥ï¼ˆä»…ç”¨äºåˆ†å‘ï¼‰
          openssl genrsa -out key.pem 2048

          # éªŒè¯ manifest.json æ˜¯å¦å­˜åœ¨
          ls -la manifest.json
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la

          # ä¸ºæ‰©å±•æ–‡ä»¶åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p extension-temp

          # å°†æ‰©å±•æ–‡ä»¶å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
          cp manifest.json extension-temp/
          cp background.js extension-temp/
          cp content.js extension-temp/
          cp popup.html extension-temp/
          cp popup.js extension-temp/
          cp -r icons extension-temp/

          # éªŒè¯ä¸´æ—¶ç›®å½•å†…å®¹
          echo "æ‰©å±•ä¸´æ—¶ç›®å½•å†…å®¹:"
          ls -la extension-temp/

          # ä»ä¸´æ—¶ç›®å½•åˆ›å»º CRX æ–‡ä»¶
          cd extension-temp
          crx3 -o ../extension.crx -p ../key.pem .
          cd ..

          echo "ğŸ“¦ å·²åˆ›å»º extension.crx"
          ls -la extension.crx

          # æ¸…ç†
          rm -rf extension-temp

      - name: å‘å¸ƒåˆ° Chrome ç½‘ä¸Šåº”ç”¨åº—
        continue-on-error: true
        id: chrome-publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: chrome-extension.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true # å¦‚æœåªæƒ³ä¸Šä¼ è€Œä¸å‘å¸ƒï¼Œè®¾ç½®ä¸º false

      - name: å‘å¸ƒåˆ° Microsoft Edge åŠ è½½é¡¹
        continue-on-error: true
        id: edge-publish
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: edge-extension.zip
          api-key: ${{ secrets.EDGE_API_KEY }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          notes-for-certification: "è‡ªåŠ¨å‘å¸ƒ v${{ steps.version.outputs.version }} - ${{ github.sha }}"

      - name: åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Xget for Chromium ${{ steps.version.outputs.version }}
          files: |
            chrome-extension.zip
            edge-extension.zip
            extension.crx
          generate_release_notes: true
          body: |
            æ­¤ç‰ˆæœ¬å·²è‡ªåŠ¨å‘å¸ƒåˆ°å¤šä¸ªæ‰©å±•å•†åº—ã€‚

            ## ğŸ“¦ å®‰è£…é€‰é¡¹

            - **Chrome ç½‘ä¸Šåº”ç”¨åº—**: [ä» Chrome ç½‘ä¸Šåº”ç”¨åº—å®‰è£…](https://chromewebstore.google.com/detail/ajiejgobfcifcikbahpijopolfjoodgf)
            - **Microsoft Edge åŠ è½½é¡¹**: [ä» Microsoft Edge åŠ è½½é¡¹å®‰è£…](https://microsoftedge.microsoft.com/addons/detail/jigpfhbegabdenhihpplcjhpfdcgnalc)
            - **æ‰‹åŠ¨å®‰è£…**: ä¸‹è½½ä¸‹é¢çš„æ–‡ä»¶æˆ–æŸ¥çœ‹ [å®‰è£…æŒ‡å—](https://github.com/xixu-me/Xget-for-Chrome?tab=readme-ov-file#-%E5%AE%89%E8%A3%85) è·å–è¯¦ç»†è¯´æ˜

            ## ğŸ“ å¯ç”¨æ–‡ä»¶

            - `chrome-extension.zip` - é€‚ç”¨äº Chrome æµè§ˆå™¨
            - `edge-extension.zip` - é€‚ç”¨äº Microsoft Edge
            - `extension.crx` - é€‚ç”¨äºæ‰€æœ‰åŸºäº Chromium çš„æµè§ˆå™¨çš„é¢„æ‰“åŒ…æ‰©å±•æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å‘å¸ƒç»“æœ
        run: |
          echo "ğŸ“Š å‘å¸ƒç»“æœæ‘˜è¦:"
          echo "================================"

          if [ "${{ steps.chrome-publish.outcome }}" = "success" ]; then
            echo "âœ… Chrome ç½‘ä¸Šåº”ç”¨åº—: å‘å¸ƒæˆåŠŸ"
          elif [ "${{ steps.chrome-publish.outcome }}" = "failure" ]; then
            echo "âŒ Chrome ç½‘ä¸Šåº”ç”¨åº—: å‘å¸ƒå¤±è´¥"
          else
            echo "âš ï¸ Chrome ç½‘ä¸Šåº”ç”¨åº—: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
          fi

          if [ "${{ steps.edge-publish.outcome }}" = "success" ]; then
            echo "âœ… Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒæˆåŠŸ"
          elif [ "${{ steps.edge-publish.outcome }}" = "failure" ]; then
            echo "âŒ Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒå¤±è´¥"
          else
            echo "âš ï¸ Microsoft Edge åŠ è½½é¡¹: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
          fi

          echo "âœ… GitHub å‘å¸ƒ: å·²åˆ›å»ºæ‰©å±•æ–‡ä»¶"
          echo "================================"

      - name: é€šçŸ¥æˆåŠŸ
        run: |
          echo "ğŸ‰ æˆåŠŸå‘å¸ƒ Xget for Chromium ${{ steps.version.outputs.version }} åˆ°å¤šä¸ªå•†åº—ï¼"
          echo "ğŸ”— Chrome ç½‘ä¸Šåº”ç”¨åº—: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}"
          echo "ğŸ”— Microsoft Edge åŠ è½½é¡¹: æŸ¥çœ‹å‘å¸ƒé¡µé¢è·å–æ‰‹åŠ¨å®‰è£…æ–‡ä»¶"
          echo "ğŸ“¦ GitHub å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
