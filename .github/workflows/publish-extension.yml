name: å‘å¸ƒæ‰©å±•åˆ°å¤šä¸ªåº”ç”¨å•†åº—

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string
      platforms:
        description: "å‘å¸ƒå¹³å°"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - chrome
          - firefox

permissions:
  contents: write
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: éªŒè¯ manifest æ–‡ä»¶
        run: |
          # éªŒè¯ manifest.json æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
          echo "âœ… Chrome manifest.json æ ¼å¼æœ‰æ•ˆ"

          # éªŒè¯ Firefox manifest
          node -e "JSON.parse(require('fs').readFileSync('manifest-firefox.json', 'utf8'))"
          echo "âœ… Firefox manifest.json æ ¼å¼æœ‰æ•ˆ"

      - name: ä»è¾“å…¥è®¾ç½®ç‰ˆæœ¬
        id: version
        run: |
          # ä½¿ç”¨æ‰‹åŠ¨æä¾›çš„ç‰ˆæœ¬
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æ‰‹åŠ¨è®¾ç½®ç‰ˆæœ¬: $VERSION"

      - name: æ›´æ–° manifest ç‰ˆæœ¬
        run: |
          # æ›´æ–° Chrome manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Chrome manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

          # æ›´æ–° Firefox manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest-firefox.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest-firefox.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Firefox manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

      - name: æ›´æ–° package.json ç‰ˆæœ¬
        run: |
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬ä»¥åŒ¹é…æ ‡ç­¾
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('å·²æ›´æ–° package.json ç‰ˆæœ¬ä¸º:', pkg.version);
          "

      - name: æäº¤å¹¶æ¨é€ç‰ˆæœ¬æ›´æ–°
        run: |
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯ä»¥è¿›è¡Œæäº¤
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
          git add manifest.json manifest-firefox.json package.json

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰ç‰ˆæœ¬æ›´æ”¹éœ€è¦æäº¤"
          else
            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git commit -m "chore: æ›´æ–°ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }} [skip ci]"
            
            # ä¸ºæ­¤ç‰ˆæœ¬åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
            git tag "v${{ steps.version.outputs.version }}"
            
            # æ¨é€åˆ°ä¸»åˆ†æ”¯å¹¶åŒ…å«æ ‡ç­¾
            git push origin HEAD:main
            git push origin "v${{ steps.version.outputs.version }}"
            
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼ŒåŒ…å«æ ‡ç­¾"
          fi

      - name: æ„å»ºæ‰©å±•åŒ…
        run: |
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºæ‰©å±•åŒ…..."

          # è¿è¡Œæ„å»ºè„šæœ¬
          if [ "${{ inputs.platforms }}" = "all" ]; then
            python build.py --platform all --package
          elif [ "${{ inputs.platforms }}" = "chrome" ]; then
            python build.py --platform chrome --package
          elif [ "${{ inputs.platforms }}" = "firefox" ]; then
            python build.py --platform firefox --package
          fi

          echo "ğŸ“¦ æ‰©å±•åŒ…æ„å»ºå®Œæˆ"
          ls -la packages/ || echo "packages ç›®å½•ä¸å­˜åœ¨"
          ls -la build/ || echo "build ç›®å½•ä¸å­˜åœ¨"

      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python dev.py test

          echo "ï¿½ è¿è¡Œä»£ç æ£€æŸ¥..."
          python dev.py lint

      - name: å‘å¸ƒåˆ° Chrome åº”ç”¨å•†åº—
        if: inputs.platforms == 'all' || inputs.platforms == 'chrome'
        continue-on-error: true
        id: chrome-publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: packages/xget-now-chrome-v${{ steps.version.outputs.version }}.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true # å¦‚æœåªæƒ³ä¸Šä¼ è€Œä¸å‘å¸ƒï¼Œè®¾ç½®ä¸º false

      - name: å‘å¸ƒåˆ° Microsoft Edge åŠ è½½é¡¹
        if: inputs.platforms == 'all' || inputs.platforms == 'chrome'
        continue-on-error: true
        id: edge-publish
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: packages/xget-now-chrome-v${{ steps.version.outputs.version }}.zip
          api-key: ${{ secrets.EDGE_API_KEY }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          notes-for-certification: "è‡ªåŠ¨å‘å¸ƒ v${{ steps.version.outputs.version }} - ${{ github.sha }}"

      - name: å‡†å¤‡ Firefox å‘å¸ƒ
        if: inputs.platforms == 'all' || inputs.platforms == 'firefox'
        continue-on-error: true
        id: firefox-prepare
        run: |
          echo "ğŸ¦Š å‡†å¤‡ Firefox æ‰©å±•å‘å¸ƒ..."

          # æ£€æŸ¥ Firefox æ‰©å±•åŒ…æ˜¯å¦å­˜åœ¨
          if [ -f "packages/xget-now-firefox-v${{ steps.version.outputs.version }}.zip" ]; then
            echo "âœ… Firefox æ‰©å±•åŒ…å­˜åœ¨"
            echo "firefox-package-exists=true" >> $GITHUB_OUTPUT
            echo "firefox-package-path=packages/xget-now-firefox-v${{ steps.version.outputs.version }}.zip" >> $GITHUB_OUTPUT
          else
            echo "âŒ Firefox æ‰©å±•åŒ…ä¸å­˜åœ¨"
            echo "firefox-package-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Xget Now ${{ steps.version.outputs.version }}
          files: |
            packages/*.zip
          generate_release_notes: true

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å‘å¸ƒç»“æœ
        run: |
          echo "ğŸ“Š å‘å¸ƒç»“æœæ‘˜è¦:"
          echo "================================"
          echo "ğŸ—ï¸ æ„å»ºå¹³å°: ${{ inputs.platforms }}"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo ""

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "chrome" ]; then
            if [ "${{ steps.chrome-publish.outcome }}" = "success" ]; then
              echo "âœ… Chrome åº”ç”¨å•†åº—: å‘å¸ƒæˆåŠŸ"
            elif [ "${{ steps.chrome-publish.outcome }}" = "failure" ]; then
              echo "âŒ Chrome åº”ç”¨å•†åº—: å‘å¸ƒå¤±è´¥"
            else
              echo "âš ï¸ Chrome åº”ç”¨å•†åº—: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
            fi

            if [ "${{ steps.edge-publish.outcome }}" = "success" ]; then
              echo "âœ… Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒæˆåŠŸ"
            elif [ "${{ steps.edge-publish.outcome }}" = "failure" ]; then
              echo "âŒ Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒå¤±è´¥"
            else
              echo "âš ï¸ Microsoft Edge åŠ è½½é¡¹: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
            fi
          fi

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "firefox" ]; then
            if [ "${{ steps.firefox-prepare.outputs.firefox-package-exists }}" = "true" ]; then
              echo "âœ… Firefox æ‰©å±•åŒ…: å·²å‡†å¤‡å°±ç»ªï¼Œéœ€è¦æ‰‹åŠ¨æäº¤åˆ° Mozilla"
            else
              echo "âŒ Firefox æ‰©å±•åŒ…: æ„å»ºå¤±è´¥"
            fi
          fi

          echo ""
          echo "âœ… GitHub å‘å¸ƒ: å·²åˆ›å»ºåŒ…å«æ‰€æœ‰æ‰©å±•æ–‡ä»¶"
          echo "================================"

      - name: é€šçŸ¥æˆåŠŸ
        run: |
          echo ""
          echo "ğŸ‰ æˆåŠŸå‘å¸ƒ Xget Now ${{ steps.version.outputs.version }}!"
          echo "================================"

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "chrome" ]; then
            echo "ğŸ”— Chrome åº”ç”¨å•†åº—: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}"
            echo "ğŸ”— Microsoft Edge åŠ è½½é¡¹: æŸ¥çœ‹å‘å¸ƒé¡µé¢è·å–æœ€æ–°ä¿¡æ¯"
          fi

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "firefox" ]; then
            echo "ğŸ¦Š Firefox: æ‰‹åŠ¨æäº¤åˆ° Mozilla Add-onsï¼ˆæ–‡ä»¶å·²å‡†å¤‡å°±ç»ªï¼‰"
          fi

          echo "ğŸ“¦ GitHub å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          echo "ğŸ“– å®‰è£…æŒ‡å—: https://github.com/${{ github.repository }}#installation"
          echo "================================"
