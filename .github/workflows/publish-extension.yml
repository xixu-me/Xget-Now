name: å‘å¸ƒæ‰©å±•åˆ°å¤šä¸ªåº”ç”¨å•†åº—

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)"
        required: true
        type: string
      platforms:
        description: "å‘å¸ƒå¹³å°"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - chrome
          - firefox

permissions:
  contents: write
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: éªŒè¯ manifest æ–‡ä»¶
        run: |
          # éªŒè¯ manifest.json æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
          echo "âœ… Chrome manifest.json æ ¼å¼æœ‰æ•ˆ"

          # éªŒè¯ Firefox manifest
          node -e "JSON.parse(require('fs').readFileSync('manifest-firefox.json', 'utf8'))"
          echo "âœ… Firefox manifest.json æ ¼å¼æœ‰æ•ˆ"

      - name: ä»Žè¾“å…¥è®¾ç½®ç‰ˆæœ¬
        id: version
        run: |
          # ä½¿ç”¨æ‰‹åŠ¨æä¾›çš„ç‰ˆæœ¬
          VERSION="${{ inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æ‰‹åŠ¨è®¾ç½®ç‰ˆæœ¬: $VERSION"

      - name: æ›´æ–° manifest ç‰ˆæœ¬
        run: |
          # æ›´æ–° Chrome manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Chrome manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

          # æ›´æ–° Firefox manifest.json ä¸­çš„ç‰ˆæœ¬
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest-firefox.json', 'utf8'));
            manifest.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('manifest-firefox.json', JSON.stringify(manifest, null, 2));
            console.log('å·²æ›´æ–° Firefox manifest.json ç‰ˆæœ¬ä¸º:', manifest.version);
          "

      - name: æ›´æ–° package.json ç‰ˆæœ¬
        run: |
          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬ä»¥åŒ¹é…æ ‡ç­¾
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
            console.log('å·²æ›´æ–° package.json ç‰ˆæœ¬ä¸º:', pkg.version);
          "

      - name: æäº¤å¹¶æŽ¨é€ç‰ˆæœ¬æ›´æ–°
        run: |
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯ä»¥è¿›è¡Œæäº¤
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
          git add manifest.json manifest-firefox.json package.json

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰ç‰ˆæœ¬æ›´æ”¹éœ€è¦æäº¤"
          else
            # æäº¤ç‰ˆæœ¬æ›´æ–°
            git commit -m "chore: æ›´æ–°ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }} [skip ci]"
            
            # ä¸ºæ­¤ç‰ˆæœ¬åˆ›å»ºå¹¶æŽ¨é€æ–°æ ‡ç­¾
            git tag "v${{ steps.version.outputs.version }}"
            
            # æŽ¨é€åˆ°ä¸»åˆ†æ”¯å¹¶åŒ…å«æ ‡ç­¾
            git push origin HEAD:main
            git push origin "v${{ steps.version.outputs.version }}"
            
            echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æŽ¨é€åˆ°ä¸»åˆ†æ”¯ï¼ŒåŒ…å«æ ‡ç­¾"
          fi

      - name: æž„å»ºæ‰©å±•åŒ…
        run: |
          echo "ðŸ—ï¸ å¼€å§‹æž„å»ºæ‰©å±•åŒ…..."

          # è¿è¡Œæž„å»ºè„šæœ¬
          if [ "${{ inputs.platforms }}" = "all" ]; then
            python build.py --platform all --package
          elif [ "${{ inputs.platforms }}" = "chrome" ]; then
            python build.py --platform chrome --package
          elif [ "${{ inputs.platforms }}" = "firefox" ]; then
            python build.py --platform firefox --package
          fi

          echo "ðŸ“¦ æ‰©å±•åŒ…æž„å»ºå®Œæˆ"
          ls -la packages/ || echo "packages ç›®å½•ä¸å­˜åœ¨"
          ls -la build/ || echo "build ç›®å½•ä¸å­˜åœ¨"

      - name: è¿è¡Œæµ‹è¯•
        run: |
          echo "ðŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
          python dev.py test

          echo "ï¿½ è¿è¡Œä»£ç æ£€æŸ¥..."
          python dev.py lint

      - name: å‘å¸ƒåˆ° Chrome åº”ç”¨å•†åº—
        if: inputs.platforms == 'all' || inputs.platforms == 'chrome'
        continue-on-error: true
        id: chrome-publish
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: packages/xget-now-chrome-v${{ steps.version.outputs.version }}.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true # å¦‚æžœåªæƒ³ä¸Šä¼ è€Œä¸å‘å¸ƒï¼Œè®¾ç½®ä¸º false

      - name: å‘å¸ƒåˆ° Microsoft Edge åŠ è½½é¡¹
        if: inputs.platforms == 'all' || inputs.platforms == 'chrome'
        continue-on-error: true
        id: edge-publish
        uses: wdzeng/edge-addon@v2
        with:
          product-id: ${{ secrets.EDGE_PRODUCT_ID }}
          zip-path: packages/xget-now-chrome-v${{ steps.version.outputs.version }}.zip
          api-key: ${{ secrets.EDGE_API_KEY }}
          client-id: ${{ secrets.EDGE_CLIENT_ID }}
          notes-for-certification: "è‡ªåŠ¨å‘å¸ƒ v${{ steps.version.outputs.version }} - ${{ github.sha }}"

      - name: å‡†å¤‡ Firefox å‘å¸ƒ
        if: inputs.platforms == 'all' || inputs.platforms == 'firefox'
        continue-on-error: true
        id: firefox-prepare
        run: |
          echo "ðŸ¦Š å‡†å¤‡ Firefox æ‰©å±•å‘å¸ƒ..."

          # æ£€æŸ¥ Firefox æ‰©å±•åŒ…æ˜¯å¦å­˜åœ¨
          if [ -f "packages/xget-now-firefox-v${{ steps.version.outputs.version }}.zip" ]; then
            echo "âœ… Firefox æ‰©å±•åŒ…å­˜åœ¨"
            echo "firefox-package-exists=true" >> $GITHUB_OUTPUT
            echo "firefox-package-path=packages/xget-now-firefox-v${{ steps.version.outputs.version }}.zip" >> $GITHUB_OUTPUT
          else
            echo "âŒ Firefox æ‰©å±•åŒ…ä¸å­˜åœ¨"
            echo "firefox-package-exists=false" >> $GITHUB_OUTPUT
          fi

          # åˆ›å»º Firefox å‘å¸ƒè¯´æ˜Ž
          cat > firefox-release-notes.txt << 'EOF'
          æ­¤ç‰ˆæœ¬çš„ Xget Now æ‰©å±•å·²é’ˆå¯¹ Firefox è¿›è¡Œä¼˜åŒ–ï¼š

          ## ðŸ†• æ–°åŠŸèƒ½
          - å®Œå…¨å…¼å®¹ Firefox Manifest V2
          - æ”¯æŒæ‰€æœ‰ä¸»è¦åŠŸèƒ½ï¼šä¸‹è½½æ‹¦æˆªã€è®¾ç½®ä¿å­˜ã€é€šçŸ¥æ˜¾ç¤º
          - è·¨æµè§ˆå™¨ API å…¼å®¹å±‚ç¡®ä¿ç¨³å®šæ€§

          ## ðŸ“¦ å®‰è£…æ–¹å¼
          1. ä¸´æ—¶å®‰è£…ï¼šabout:debugging â†’ ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶
          2. æ‰‹åŠ¨å®‰è£…ï¼šä¸‹è½½ .zip æ–‡ä»¶å¹¶è§£åŽ‹åŠ è½½
          3. ç­‰å¾… Mozilla å®¡æ ¸é€šè¿‡åŽä»Ž Add-ons å•†åº—å®‰è£…

          ## ðŸ”§ æŠ€æœ¯æ”¹è¿›
          - ä½¿ç”¨ç»Ÿä¸€çš„ WebExtension API å…¼å®¹å±‚
          - ä¼˜åŒ– Firefox ç‰¹æœ‰çš„æƒé™å’Œ API è°ƒç”¨
          - æ”¹è¿›é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ
          EOF

      - name: åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Xget Now ${{ steps.version.outputs.version }}
          files: |
            packages/*.zip
          generate_release_notes: true
          body: |
            ðŸŽ‰ æ­¤ç‰ˆæœ¬å·²è‡ªåŠ¨å‘å¸ƒï¼ŒçŽ°åœ¨æ”¯æŒå¤šä¸ªæµè§ˆå™¨å¹³å°ï¼

            ## ðŸ“¦ å®‰è£…é€‰é¡¹

            ### Chrome ç³»åˆ—æµè§ˆå™¨
            - **Chrome åº”ç”¨å•†åº—**: [ä»Ž Chrome åº”ç”¨å•†åº—å®‰è£…](https://chromewebstore.google.com/detail/ajiejgobfcifcikbahpijopolfjoodgf?hl=zh-CN)
            - **Microsoft Edge åŠ è½½é¡¹**: [ä»Ž Microsoft Edge åŠ è½½é¡¹å®‰è£…](https://microsoftedge.microsoft.com/addons/detail/jigpfhbegabdenhihpplcjhpfdcgnalc?hl=zh-CN&gl=CN)
            - **æ‰‹åŠ¨å®‰è£…**: ä¸‹è½½ `xget-now-chrome-v${{ steps.version.outputs.version }}.zip`

            ### Firefox æµè§ˆå™¨
            - **Firefox Add-ons**: ðŸš§ ç­‰å¾… Mozilla å®¡æ ¸ï¼ˆå³å°†æŽ¨å‡ºï¼‰
            - **æ‰‹åŠ¨å®‰è£…**: ä¸‹è½½ `xget-now-firefox-v${{ steps.version.outputs.version }}.zip` å¹¶å‚è€ƒ [Firefox å®‰è£…æŒ‡å—](https://github.com/xixu-me/Xget-Now/blob/main/FIREFOX_INSTALL.md)

            ## ðŸ†• æ–°åŠŸèƒ½äº®ç‚¹

            - âœ… **Firefox å®Œå…¨æ”¯æŒ**: çŽ°åœ¨åŒæ—¶æ”¯æŒ Chrome å’Œ Firefox æµè§ˆå™¨
            - âœ… **ç»Ÿä¸€åŠŸèƒ½ä½“éªŒ**: ä¸¤ä¸ªå¹³å°æä¾›å®Œå…¨ä¸€è‡´çš„åŠŸèƒ½
            - âœ… **è‡ªåŠ¨å¹³å°æ£€æµ‹**: æ‰©å±•ä¼šè‡ªåŠ¨é€‚é…å½“å‰æµè§ˆå™¨çŽ¯å¢ƒ
            - âœ… **è·¨æµè§ˆå™¨å…¼å®¹**: ä½¿ç”¨ç»Ÿä¸€çš„ API å…¼å®¹å±‚ç¡®ä¿ç¨³å®šæ€§

            ## ðŸ“ å¯ç”¨æ–‡ä»¶

            - `xget-now-chrome-v${{ steps.version.outputs.version }}.zip` - é€‚ç”¨äºŽ Chromeã€Edgeã€Braveã€Opera ç­‰åŸºäºŽ Chromium çš„æµè§ˆå™¨
            - `xget-now-firefox-v${{ steps.version.outputs.version }}.zip` - ä¸“ä¸º Firefox ä¼˜åŒ–çš„ç‰ˆæœ¬

            ## ðŸ› ï¸ å¼€å‘è€…ä¿¡æ¯

            æ­¤ç‰ˆæœ¬å¼•å…¥äº†å¤šå¹³å°æ”¯æŒæž¶æž„ï¼š
            - ä½¿ç”¨ Manifest V3 (Chrome) å’Œ Manifest V2 (Firefox)
            - ç»Ÿä¸€çš„ WebExtension API å…¼å®¹å±‚
            - è‡ªåŠ¨åŒ–æž„å»ºå’Œæµ‹è¯•æµç¨‹

            è¯¦ç»†æŠ€æœ¯æ–‡æ¡£è¯·å‚è€ƒ [Firefox æ”¯æŒè¯´æ˜Ž](https://github.com/xixu-me/Xget-Now/blob/main/FIREFOX_SUPPORT.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥å‘å¸ƒç»“æžœ
        run: |
          echo "ðŸ“Š å‘å¸ƒç»“æžœæ‘˜è¦:"
          echo "================================"
          echo "ðŸ—ï¸ æž„å»ºå¹³å°: ${{ inputs.platforms }}"
          echo "ðŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo ""

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "chrome" ]; then
            if [ "${{ steps.chrome-publish.outcome }}" = "success" ]; then
              echo "âœ… Chrome åº”ç”¨å•†åº—: å‘å¸ƒæˆåŠŸ"
            elif [ "${{ steps.chrome-publish.outcome }}" = "failure" ]; then
              echo "âŒ Chrome åº”ç”¨å•†åº—: å‘å¸ƒå¤±è´¥"
            else
              echo "âš ï¸ Chrome åº”ç”¨å•†åº—: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
            fi

            if [ "${{ steps.edge-publish.outcome }}" = "success" ]; then
              echo "âœ… Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒæˆåŠŸ"
            elif [ "${{ steps.edge-publish.outcome }}" = "failure" ]; then
              echo "âŒ Microsoft Edge åŠ è½½é¡¹: å‘å¸ƒå¤±è´¥"
            else
              echo "âš ï¸ Microsoft Edge åŠ è½½é¡¹: å·²è·³è¿‡ï¼ˆç¼ºå°‘å¯†é’¥ï¼‰"
            fi
          fi

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "firefox" ]; then
            if [ "${{ steps.firefox-prepare.outputs.firefox-package-exists }}" = "true" ]; then
              echo "âœ… Firefox æ‰©å±•åŒ…: å·²å‡†å¤‡å°±ç»ªï¼Œéœ€è¦æ‰‹åŠ¨æäº¤åˆ° Mozilla"
            else
              echo "âŒ Firefox æ‰©å±•åŒ…: æž„å»ºå¤±è´¥"
            fi
          fi

          echo ""
          echo "âœ… GitHub å‘å¸ƒ: å·²åˆ›å»ºåŒ…å«æ‰€æœ‰æ‰©å±•æ–‡ä»¶"
          echo "================================"

      - name: Firefox å‘å¸ƒæé†’
        if: (inputs.platforms == 'all' || inputs.platforms == 'firefox') && steps.firefox-prepare.outputs.firefox-package-exists == 'true'
        run: |
          echo ""
          echo "ðŸ¦Š Firefox å‘å¸ƒæé†’:"
          echo "================================"
          echo "Firefox æ‰©å±•å·²æž„å»ºå®Œæˆï¼Œä½†éœ€è¦æ‰‹åŠ¨æäº¤åˆ° Mozilla Add-ons:"
          echo ""
          echo "1. è®¿é—®: https://addons.mozilla.org/developers/"
          echo "2. ç™»å½•æ‚¨çš„å¼€å‘è€…è´¦æˆ·"
          echo "3. ä¸Šä¼ æ–‡ä»¶: packages/xget-now-firefox-v${{ steps.version.outputs.version }}.zip"
          echo "4. å¡«å†™å‘å¸ƒä¿¡æ¯å¹¶æäº¤å®¡æ ¸"
          echo ""
          echo "Mozilla å®¡æ ¸é€šå¸¸éœ€è¦å‡ å¤©åˆ°å‡ å‘¨æ—¶é—´ã€‚"
          echo "åœ¨æ­¤æœŸé—´ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å®‰è£…æ‰©å±•æ–‡ä»¶ã€‚"
          echo "================================"

      - name: é€šçŸ¥æˆåŠŸ
        run: |
          echo ""
          echo "ðŸŽ‰ æˆåŠŸå‘å¸ƒ Xget Now ${{ steps.version.outputs.version }}!"
          echo "================================"

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "chrome" ]; then
            echo "ðŸ”— Chrome åº”ç”¨å•†åº—: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}"
            echo "ðŸ”— Microsoft Edge åŠ è½½é¡¹: æŸ¥çœ‹å‘å¸ƒé¡µé¢èŽ·å–æœ€æ–°ä¿¡æ¯"
          fi

          if [ "${{ inputs.platforms }}" = "all" ] || [ "${{ inputs.platforms }}" = "firefox" ]; then
            echo "ðŸ¦Š Firefox: æ‰‹åŠ¨æäº¤åˆ° Mozilla Add-onsï¼ˆæ–‡ä»¶å·²å‡†å¤‡å°±ç»ªï¼‰"
          fi

          echo "ðŸ“¦ GitHub å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          echo "ðŸ“– å®‰è£…æŒ‡å—: https://github.com/${{ github.repository }}#installation"
          echo "================================"
